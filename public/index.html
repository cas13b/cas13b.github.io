<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>KRAS Annotation</title>
    <meta name="apple-mobile-web-app-capable" content="yes">

	<link rel="stylesheet" href="/css/main.css">
    <script src="/js/vendor.min.js"></script>
    <script src="/js/showdown.min.js"></script>
    <script src="/js/bionode-seq.min.js"></script>

<style>
    textarea {
        font-family:Consolas,Monaco,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New, monospace;
    }

    td#advancedOptionsButton {
        text-align: center;
        line-height: 2em;
    }
    tr#advancedOptions.hidden {
        display: none;
    }
    tr#advancedOptions td div.option {
        padding: 0 10px;
        width: 25%;
        float: left;
    }
    div#outputs {
        margin: auto;
    }

    div#outputs.double div#output_div {
        float: left;
        width: 50%;
        padding: 0 5px;
    }
    div#outputs.double div#output_div textarea {
        width: 100%;
    }
    div#outputs.double div#extra_output_div {
        float: left;
        width: 50%;
        padding: 0 5px;
    }
    div#outputs.double div#extra_output_div textarea {
        width: 100%;
    }
    h2 {
        font-size: 16px;
        font-weight: 700;
        line-height: 1.5em;
        margin: 0;
    }
    div#outputs p {
        margin: 0;
    }

    #advancedOptions label, #advancedOptions input {
        cursor: pointer;
    }

    #advancedOptions input[disabled] {
        cursor: not-allowed;
    }
    #advancedOptions input[disabled] + label {
        text-decoration: line-through;
        cursor: not-allowed;
    }
</style>
</head>

<body>
    <center>
    <h1><font color="Red"> Cas13 </font>: Tiling experiment guide RNA Target Design Server</h1>
    <b>(ACADEMIC USE ONLY)</b>
    </center>

    <center>
    <form enctype="multipart/form-data">
    <table>

    <tbody>
    <tr>
        <td align="left" colspan="2"><h2>Input your RNA/DNA Sequence:</h2></td>
    </tr> 

    <tr>
        <td colspan="2">
            <textarea name="fasta_sequence" id="fasta_sequence" rows="8" cols="100"></textarea>
        </td>
    </tr>

    <tr>
        <td align="center">Spacer Length:</td>
        <td align="left"><input placeholder='30' type="TEXT" value="" name="F_primer" id="spacer_length" size="75"></td>
    </tr>

    <tr>
        <td align="center">Target Intervals (nt):</td>
        <td align="left"><input placeholder='1' type="TEXT" value="" name="F_primer" id="intervals" size="75"></td>
    </tr>

    <tr>
        <td align="center">5' Oligo Adapter:</td>
        <td align="left"><input type="TEXT" value="" name="F_primer" id="F_primer" size="75"></td>
    </tr>

    <tr>
        <td align="center">3' Oligo Adapter:</td>
        <td align="left"><input type="TEXT" value="" name="R_primer" id="R_primer" size="75"></td>
    </tr>

<!-- 
    <tr>
    <td align="center"> E-mail address (optional):</td>
    <td align="left"> <input type="TEXT" value="" name="REPLY-E-MAIL" size="40"></td>
    </tr>
-->

<tr>
    <td id="advancedOptionsButton" colspan="2"><a href="#advanced" onclick="$('#advancedOptions').toggleClass('hidden')">Advanced Options</a></td>
</tr>

<tr id='advancedOptions' class='hidden'>
    <td colspan="2">
        <!-- Make forward or reverse optional -->
        <div class='option'>
            <input type="radio" id="showBoth" name="strands_shown" value="both" checked="true">
            <label for="showBoth">Show both</label><br>
            <input type="radio" id="showForward" name="strands_shown" value="forward">
            <label for="showForward">Forward Strand</label><br>
            <input type="radio" id="showReverse" name="strands_shown" value="reverse">
            <label for="showReverse">Reverse Strand</label><br>
        </div>

        <div class='option'>
            <input type="radio" id="classic_radio" name="format" value="classic" checked="true">
            <label for="classic_radio">Classic format</label><br>
            <input type="radio" id="fasta_radio" name="format" value="fasta">
            <label for="fasta_radio">Fasta format</label><br>

        </div>

        <div class='option' style="width: 35%;">
            <input type="radio" id="collate_radio" name="lines" value="collate" checked="true">
            <label for="collate_radio">Collate forward and reverse primers </label><br>
            <input type="radio" id="separate_radio" name="lines" value="separate">
            <label for="separate_radio">Forward primers, then reverse primers</label><br>
            <input type="radio" id="double_radio" name="lines" value="double">
            <label for="double_radio">Both primers on the same line</label><br>
            <input type="radio" id="files_radio" name="lines" value="files">
            <label for="files_radio">Separate output files</label><br>
        </div>

        <div class='option' style="width: 15%;">
            <input type="radio" id="spaces_radio" name="separator" value="spaces" checked="true">
            <label for="spaces_radio">Spaces</label><br>
            <input type="radio" id="tabs_radio" name="separator" value="tabs">
            <label for="tabs_radio">Tabs</label><br>
        </div>
    </td>
</tr>

    </tbody></table>
    <input type="BUTTON" value="Show Example" onclick="show_example()">
    <input type="SUBMIT" value="Submit" onclick="submit_sequence()">
    <input type="RESET" value="Clear" onclick="clear_results()">
    <input type="hidden" name="METHOD" value="Go!">

</form>


<div id="outputs">
    <div id='errors_div' style="display: none;">
        <h2 style="color: red;">Errors:</h2>
        <textarea id='errors' rows="8" cols="100"></textarea>
    </div>

    <div id='output_div' style="display: none;">
        <h2>Output:</h2> 
        <p><a id="download_csv" onclick="update_data('#download_csv', '#output')" target="_blank" href="#results.txt" download="results.txt">Download as .txt file</a></p>
        <textarea id='output' rows="8" cols="100"></textarea>
    </div>

    <div id='extra_output_div' style="display: none;">
        <h2>Reverse Output:</h2> 
        <p><a id="download_extra_csv" onclick="update_data('#download_extra_csv', '#extra_output')" target="_blank" href="#reverse.txt" download="reverse.txt">Download as .txt file</a></p>
        <textarea id='extra_output' rows="8" cols="100"></textarea>
    </div>

    <div id='stats_div' style="display: none;">
        <h2>Stats:</h2>
        <textarea id='stats' rows="8" cols="100"></textarea>

        <div id="chart_div">
            <h2>GC content of generated guide RNA:</h2>
            <svg id="chart" viewBox="0 0 900 600"></svg>
        </div>
    </div>
</div>

<br>
<p>
<b>If you are using Cas13-gRNA server in your research, please cite:</b>
<br>
XXXXX, (Under review).
</p>

    <center>
        <p> <font size="0.5"> Copyright @ 2020 Peter MacCallum Cancer Centre, Australia. </font></p>
    </center>
</center>


<script type="text/javascript">
const seq = require('bionode-seq');
const md = new showdown.Converter({openLinksInNewWindow: true});


// Display an example
function show_example() {
    $("#fasta_sequence").val('ATTAAAGGTTTATACCTTCCCAGGTAACAAACCAACCAACTTTCGATCTCTTGTAGATCTGTTCTCTAAACGAACTTTAAAATCTGTGTGGCTGTCACTCGGCTGCATGCTTAGTGCACTCACGCAGTATAATTAATAACTAATTACTGTCGTTGACAGGACACGAGTAACTCGTCTATCTTCTGCAGGCTGCTTACGGTTTCGTCCGTGTTGCAGCCGATCATCAGCACATCTAGGTTTCGTCCGGGTGTGACCGAAAGGTAAGATGGAGAGCCTTGTCCCTGGTTTCAACGAGAAAACACACGTCCAACTCAGTTTGCCTGTTTTACAGGTTCGCGACGTGCTCGTACGTGGCTTTGGAGACTCCGTGGAGGAGGTCTTATCAGAGGCACGTCAACATCTTAAAGATGGCACTTGTGGCTTAGTAGAAG');
    $("#spacer_length").val(30);
    $("#intervals").val(1);
    $("#F_primer").val('cacc');
    $("#R_primer").val('caac');
}

function clear_results() {
    $("#errors_div").css("display", 'none');
    $("#stats_div").css("display", 'none');
    $("#output_div").css("display", 'none');
    $("#extra_output_div").css("display", 'none');

    $("#outputs").removeClass("double");
    $('textarea#errors').val("");
    $('textarea#output').val("");
    $('textarea#extra_output').val("");
    $('textarea#stats').val("");

    setTimeout(function(){
        updateDisabledOptions();
    }, 50);
}

function getOptions() {
    var data = $("form").serializeArray()
        .reduce( (result, val) => {
            result[val.name] = val.value;
            return result;
        }, {});

    var options = {
        strands_shown: data.strands_shown,
        format: data.format,
        lines: data.lines,
        separator: data.separator
    };

    return options;
}

function submit_sequence() {
    if(event) event.preventDefault();

    clear_results();
    $("#output_div").css("display", 'block');

    var options = getOptions();
    var errors = [];





// Calculate sequences
    var sequence = $("#fasta_sequence").val().toUpperCase(),
        F_primer = $("#F_primer").val().toLowerCase(),
        R_primer = $("#R_primer").val().toLowerCase(),
        spacer_length = parseInt($("#spacer_length").val()),
        intervals = parseInt($("#intervals").val());

    var outputs = [];
    var forward_seq = [];
    var reverse_seq = [];
    var pos = 0;

    if ($("#spacer_length").val() === '') spacer_length = 30;
    if ($("#intervals").val() === '') intervals = 1;

    if((!Number.isInteger(intervals) && $("#intervals").val() !== '') || intervals < 1 || parseInt($("#intervals").val()) === 0) {
        var message = "Intervals must be an integer 1 or greater, setting 'intervals' to 1.";
        errors.push(message);
        intervals = 1;
    }

    if((!Number.isInteger(spacer_length) && $("#spacer_length").val() !== '') || spacer_length < 1 || parseInt($("#spacer_length").val()) === 0) {
        var message = "Spacer Length must be an integer 1 or greater, setting 'spacer_length' to 1.";
        errors.push(message);
        spacer_length = 1;
    }

    if(seq.checkType(sequence, 1) == 'dna' || seq.checkType(sequence, 1) == 'rna') {
        // console.log("Sequence is fine, no errors.");
    } else {
        var message = "Input sequence is not DNA or RNA";
        errors.push(message);
    }

    while(pos < sequence.length) {
        if(pos + spacer_length < sequence.length) {
            var match = sequence.slice(pos, pos + spacer_length);
            forward_seq.push(`${F_primer}${seq.reverse(seq.complement(match))}`);
            reverse_seq.push(`${R_primer}${match}`);
        }
        pos += intervals;
    }

// Save sequences to #output for charting purposes
    d3.select("#output").datum({
        forward_seq: forward_seq,
        reverse_seq: reverse_seq
    });
    drawChart();

// Apply options
    var separator = options.separator == "tabs" ? "\t" : " ";

    if (options.format == 'fasta') {
        forward_seq = forward_seq.map( (d, i) => `>gRNA_${i+1}_F\n${d.replace(/.{80}/g, "$0\n")}`);
        reverse_seq = reverse_seq.map( (d, i) => `>gRNA_${i+1}_R\n${d.replace(/.{80}/g, "$0\n")}`);
    } else {
        forward_seq = forward_seq.map( (d, i) => `gRNA_${i+1}_F${separator}${d}`);
        reverse_seq = reverse_seq.map( (d, i) => `gRNA_${i+1}_R${separator}${d}`);
    }

    if (options.lines == 'collate') {
        for(var i = 0; i < forward_seq.length; i++) {
            outputs.push(forward_seq[i]);
            outputs.push(reverse_seq[i]);
        }
    } else if (options.lines == 'separate') {
        outputs = forward_seq.concat(reverse_seq);
    } else if (options.lines == 'double') {
        for(var i = 0; i < forward_seq.length; i++) {
            outputs.push(forward_seq[i] + separator + reverse_seq[i]);
        }
    }


// Print output
    if (options.strands_shown == 'forward') {
        $("#output").val(forward_seq.join("\n"));
    } else if (options.strands_shown == 'reverse') {
        $("#output").val(reverse_seq.join("\n"));
    } else {
        if (options.lines != 'files') {
            $("#output").val(outputs.join("\n"));
        } else {
            $("#output").val(forward_seq.join("\n"));
            $("#outputs").addClass("double");
            $("#extra_output_div").css("display", "block");
            $("#extra_output").val(reverse_seq.join("\n"));
        }
    }

    if( spacer_length > sequence.length ) {
        errors.push("Warning, spacer length is longer than sequence length.");
    }

// Print any errors
    if(errors.length > 0) {
        $("#errors_div").css("display", 'block');
        $("#errors").val(errors.join("\n"));
    }

// Print stats
    var stats = [];
    stats.push(`Sequence length: ${sequence.length}`);
    stats.push(`GC content: ${countGCcontent(sequence)}%`);
    if(options.strands_shown == 'both') {
        stats.push(`Number of guide RNAs created: ${forward_seq.length + reverse_seq.length}`);
    } else if (options.strands_shown == 'forward') {
        stats.push(`Number of guide RNAs created: ${forward_seq.length}`);
    } else if (options.strands_shown == 'reverse') {
        stats.push(`Number of guide RNAs created: ${reverse_seq.length}`);
    }

    $("#stats_div").css("display", 'block');
    $("#stats").val(stats.join("\n"));
}

function update_data(link, data) {
    $(link).prop('href', `data:text/plain;charset=utf-8,${encodeURIComponent($(data).val())}`);
}

function countGCcontent(sequence) {
    var total = sequence.length,
        gc = 0;
    sequence.split('').forEach(char => {
        if(char == 'c' || char == 'C' || char == 'g' | char == 'G') gc++;
    });
    return Math.floor((100 * gc)/total);
}

$("#advancedOptions input").change(() => {
    updateDisabledOptions();
    if($("#fasta_sequence").val() && $("#output").val()) submit_sequence();
});

function updateDisabledOptions(){
    const options = getOptions();

    if(options.strands_shown == 'both') {
        $("input[name='lines']").prop('disabled', false);

        if(options.format == 'fasta') {
            $("#double_radio").prop('disabled', true);

            if($("#double_radio").prop('checked')) {
                $("#collate_radio").prop('checked', true);
            }
        } else {
            $("#double_radio").prop('disabled', false);
        }
    } else {
        $("input[name='lines']").prop('disabled', true);
    }

    if(options.format == 'classic') {
        $("input[name='separator']").prop('disabled', false);
    } else {
        $("input[name='separator']").prop('disabled', true);
    }
}

if(location.hash == "#advanced") {
    $("#advancedOptions").removeClass("hidden");
}

</script>

<style>
#chart_div {
    width: 900px;
    margin: auto;
    text-align: center;
}
</style>

<script>

function drawChart() {
    console.log("Drawing chart");

    var data = [];
    data = data.concat(d3.select("#output").datum().forward_seq.map((d, i) => {
        return {
            x: i,
            label: `gRNA_${i+1}_F`,
            seq: d,
            gc: countGCcontent(d),
            type: 'forward'
        }
    }));

    data = data.concat(d3.select("#output").datum().reverse_seq.map((d, i) => {
        return {
            x: i,
            label: `gRNA_${i+1}_R`,
            seq: d,
            gc: countGCcontent(d),
            type: 'reverse'
        }
    }));

    // set the dimensions and margins of the graph
    var margin = {top: 10, right: 30, bottom: 40, left: 50},
        width = 900 - margin.left - margin.right,
        height = 600 - margin.top - margin.bottom;

    d3.select("#chart g").remove();
    // append the svg object to the body of the page
    var svg = d3.select("#chart")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
    .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")")

    // Add the grey background that makes ggplot2 famous
    svg
    .append("rect")
        .attr("x",0)
        .attr("y",0)
        .attr("height", height)
        .attr("width", width)
        .style("fill", "EBEBEB")

    // Add X axis
    var x = d3.scaleLinear()
        .domain([-10, d3.select("#output").datum().forward_seq.length])
        .range([ 0, width ])
    svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x).tickSize(-height*1.3).ticks(10))
        .select(".domain").remove()

    // Add Y axis
    var y = d3.scaleLinear()
        .domain([0, 100])
        .range([ height, 0])
        .nice()
    svg.append("g")
        .call(d3.axisLeft(y).tickSize(-width*1.3).ticks(7))
        .select(".domain").remove()

    // Customization
    svg.selectAll(".tick line").attr("stroke", "white")

    // Add X axis label:
    svg.append("text")
        .attr("text-anchor", "end")
        .attr("x", width/2 + margin.left)
        .attr("y", height + margin.top + 20)
        .text("gRNA position");

    // Y axis label:
    svg.append("text")
        .attr("text-anchor", "end")
        .attr("transform", "rotate(-90)")
        .attr("y", -margin.left + 20)
        .attr("x", -margin.top - height/2 + 20)
        .text("GC content %")

    // Color scale: give me a specie name, I return a color
    var color = d3.scaleOrdinal()
        .domain(["forward", "reverse", "average" ])
        .range([ "#F8766D", "#00BA38", "#619CFF"])


    var tooltip, background, closeButton, title, sequence, gcContent;

    // Add dots
    svg.append('g')
        .selectAll("dot")
        .data(data)
        .enter()
        .append("circle")
        .attr("cx", function (d) { return x(d.x); } )
        .attr("cy", function (d) { return y(d.gc); } )
        .attr("r", 4)
        .style("opacity", 0.5)
        .style("fill", function (d) { return color(d.type) } )
        .on("mouseover", d => {
            tooltip.style("display", "block");
            tooltip.attr("transform", `translate(${x(d.x) + 10}, ${y(d.gc) - 50})`);
            title.text(d.label);
            sequence.text(d.seq);
            gcContent.text(`GC: ${d.gc}%`);
            // console.log($(sequence).width());
            background.attr('width', sequence.node().getBBox().width + 20);
            closeButton.attr('x', sequence.node().getBBox().width + 5);
        });

    // Add label
    tooltip = svg.append("g")
        .style("display", "none")
        .attrs({
            id: "chart-tooltip"
        });
    background = tooltip.append("rect")
        .attrs({
            width: '370px',
            height: '70px',
            fill: 'white',
            stroke: "black",
            rx: '5px'
        });
    closeButton = tooltip.append("text").text("X").attrs({
        x: 355,
        y: 18,
        'font-weight': 700
    }).style("cursor", "pointer")
    .on('click', () => {tooltip.style("display", "none")});

    title = tooltip.append('text').text("title")
        .attrs({
            x: 10,
            y: 20
        });
    sequence = tooltip.append('text').text("sequence")
        .attrs({
            x: 10,
            y: 40
        });
    gcContent = tooltip.append('text').text("gc Content")
        .attrs({
            x: 10,
            y: 60
        });
}

</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-76178877-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-76178877-2');
</script>

</body>

</html>